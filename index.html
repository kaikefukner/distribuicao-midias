<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuição de Mídias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(29, 78, 216, 0.2);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 3px solid #1d4ed8;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
            display: block;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 3px;
        }
        
        .calendar-compact {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .month-header {
            background: #1e3a8a;
            color: white;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .calendar-table th {
            background: #e5e7eb;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calendar-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            height: 50px; /* Aumentado de 35px para 50px */
            position: relative;
            min-width: 45px; /* Largura mínima garantida */
        }
        
        .date-cell {
            font-size: 12px;
            color: #6b7280;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 2px;
        }
        
        .date-cell.current-month {
            color: #374151;
            font-weight: 500;
        }
        
        .date-cell.has-spots {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 700;
            border-radius: 4px;
        }
        
        .date-cell.selected-weekday {
            background: #f3f4f6;
        }
        
        .date-number {
            font-size: 12px;
            line-height: 1;
            margin-bottom: 2px;
        }

        /* NOVO SISTEMA DE BADGES ADAPTATIVO */
        .spots-container {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 18px; /* Deixa espaço para o número do dia */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-end;
            padding: 2px;
            pointer-events: none;
        }

        .spots-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            max-width: 100%;
            justify-content: flex-end;
            align-content: flex-start;
            pointer-events: auto;
        }

        .spots-badges.horizontal {
            flex-direction: row;
            max-height: 16px;
        }

        .spots-badges.vertical {
            flex-direction: column;
            max-height: 28px;
        }

        .spot-badge {
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.4);
            cursor: help;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .spot-badge:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Badge consolidado para muitos produtos */
        .consolidated-badge {
            background: linear-gradient(135deg, #1d4ed8, #7c3aed);
            font-size: 7px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: help;
            position: relative;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.1); }
        }

        .badge-spots30 { background: #1d4ed8; }
        .badge-spots5 { background: #059669; }
        .badge-spots15 { background: #dc2626; }
        .badge-spots60 { background: #7c3aed; }
        .badge-test60 { background: #ea580c; }
        
        .weekdays-info {
            background: #f8fafc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 3px solid #1d4ed8;
        }
        
        .weekdays-info strong {
            color: #1e3a8a;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .weekdays-list {
            color: #6b7280;
            font-size: 11px;
            margin-top: 3px;
        }

        .product-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-right: 8px;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }

        .product-tag:hover {
            transform: translateY(-1px);
        }

        .tag-spots30 { background: #1d4ed8; }
        .tag-spots5 { background: #059669; }
        .tag-spots15 { background: #dc2626; }
        .tag-spots60 { background: #7c3aed; }
        .tag-test60 { background: #ea580c; }

        /* TOOLTIP MELHORADO */
        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 500;
            max-width: 200px;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(-15px);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
            transform: translateX(-50%);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-table th,
            .calendar-table td {
                padding: 3px 2px;
                font-size: 10px;
                height: 45px;
                min-width: 35px;
            }
            
            .spot-badge {
                width: 12px;
                height: 12px;
                font-size: 7px;
            }

            .consolidated-badge {
                width: 14px;
                height: 14px;
                font-size: 6px;
            }

            .date-number {
                font-size: 10px;
            }

            .product-tag {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (max-width: 480px) {
            .calendar-table td {
                height: 40px;
                min-width: 30px;
            }

            .spot-badge {
                width: 10px;
                height: 10px;
                font-size: 6px;
            }

            .consolidated-badge {
                width: 12px;
                height: 12px;
                font-size: 5px;
            }
        }

        /* ANIMAÇÕES DE ENTRADA */
        .calendar-compact {
            animation: slideInUp 0.4s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">Distribuição de Mídias</h1>
            <p id="subtitle">Carregando informações da campanha...</p>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="products-info" class="weekdays-info" style="display: none;">
            <div><strong>Produtos Ativos:</strong></div>
            <div class="weekdays-list" id="active-products"></div>
        </div>
        
        <div id="weekdays-info" class="weekdays-info" style="display: none;">
            <div><strong>Dias Selecionados:</strong></div>
            <div class="weekdays-list" id="selected-weekdays"></div>
        </div>
        
        <div class="stats-grid" id="stats" style="display: none;">
            <div class="stat-card">
                <span class="stat-number" id="total-spots">0</span>
                <div class="stat-label">Total Spots</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="total-days">0</span>
                <div class="stat-label">Dias Ativos</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="avg-spots">0</span>
                <div class="stat-label">Média/Dia</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="period-range">-</span>
                <div class="stat-label">Período</div>
            </div>
        </div>
        
        <div id="calendar-container"></div>
    </div>

    <!-- Tooltip para informações detalhadas -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        console.log('🚀 Sistema iniciando com layout adaptativo melhorado...');
        
        let tooltip = null;

        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                spots30: parseInt(params.get('spots30')) || 0,
                spots5: parseInt(params.get('spots5')) || 0,
                spots15: parseInt(params.get('spots15')) || 0,
                spots60: parseInt(params.get('spots60')) || 0,
                test60: parseInt(params.get('test60')) || 0,
                emissora: params.get('emissora') || 'Emissora',
                inicio: params.get('inicio') || '01/10/2025',
                fim: params.get('fim') || '31/10/2025',
                dias: params.get('dias') || 'Seg.,Ter.,Qua.,Qui.,Sex.'
            };
        }

        function getActiveProducts(params) {
            const products = {
                spots30: params.spots30,
                spots5: params.spots5,
                spots15: params.spots15,
                spots60: params.spots60,
                test60: params.test60
            };
            
            return Object.fromEntries(
                Object.entries(products).filter(([_, value]) => value > 0)
            );
        }

        function getProductName(productType) {
            const productNames = {
                'spots30': 'Spots 30"',
                'spots5': 'Spots 5"', 
                'spots15': 'Spots 15"',
                'spots60': 'Spots 60"',
                'test60': 'Test. 60"'
            };
            return productNames[productType] || productType;
        }

        function getProductColor(productType) {
            const colors = {
                'spots30': '#1d4ed8',
                'spots5': '#059669',
                'spots15': '#dc2626', 
                'spots60': '#7c3aed',
                'test60': '#ea580c'
            };
            return colors[productType] || '#6b7280';
        }

        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR');
        }

        function parseSelectedWeekdays(diasStr) {
            const mapping = {
                'Dom.': 0, 'Seg.': 1, 'Ter.': 2, 'Qua.': 3, 
                'Qui.': 4, 'Sex.': 5, 'Sáb.': 6
            };
            
            return diasStr.split(',').map(day => mapping[day.trim()]).filter(d => d !== undefined);
        }

        function isDaySelected(date, selectedWeekdays) {
            return selectedWeekdays.includes(date.getDay());
        }

        function getValidDays(startDate, endDate, selectedWeekdays) {
            const validDays = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                if (isDaySelected(current, selectedWeekdays)) {
                    validDays.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            
            return validDays;
        }

        // ✅ FUNÇÃO CORRIGIDA - AGORA GARANTE QUE TODOS OS PRODUTOS APAREÇAM
        function distributeMultipleSpots(products, validDays) {
            const totalSpots = Object.values(products).reduce((sum, spots) => sum + spots, 0);
            
            if (totalSpots === 0) {
                return { distribution: {}, totalSpots: 0 };
            }
            
            const distribution = {};
            const productEntries = Object.entries(products);
            
            // Inicializar distribuição para todos os dias
            validDays.forEach(day => {
                const dateKey = day.toISOString().split('T')[0];
                distribution[dateKey] = { total: 0, products: {} };
            });
            
            // ESTRATÉGIA CORRIGIDA: Distribuir cada produto individualmente
            // Isso garante que produtos minoritários sempre apareçam
            productEntries.forEach(([productType, totalSpotsForProduct]) => {
                // Calcular em quantos dias este produto deve aparecer
                // Produtos com poucos spots = poucos dias, mas GARANTIDO que aparecem
                const daysForThisProduct = Math.min(totalSpotsForProduct, validDays.length);
                const spotsPerDayForProduct = Math.floor(totalSpotsForProduct / daysForThisProduct);
                let remainingSpotsForProduct = totalSpotsForProduct % daysForThisProduct;
                
                console.log(`📊 Produto ${productType}: ${totalSpotsForProduct} spots em ${daysForThisProduct} dias`);
                
                // Distribuir este produto específico ao longo dos dias escolhidos
                for (let i = 0; i < daysForThisProduct; i++) {
                    // Espalhar uniformemente ao longo do período
                    const dayIndex = Math.floor((i * validDays.length) / daysForThisProduct);
                    const dateKey = validDays[dayIndex].toISOString().split('T')[0];
                    
                    const spotsForThisDay = spotsPerDayForProduct + (remainingSpotsForProduct > 0 ? 1 : 0);
                    if (remainingSpotsForProduct > 0) remainingSpotsForProduct--;
                    
                    distribution[dateKey].products[productType] = 
                        (distribution[dateKey].products[productType] || 0) + spotsForThisDay;
                    distribution[dateKey].total += spotsForThisDay;
                    
                    console.log(`✅ ${productType}: +${spotsForThisDay} spots no dia ${dateKey}`);
                }
            });
            
            console.log('🎯 Distribuição CORRIGIDA calculada:', distribution);
            return { distribution, totalSpots };
        }

        function distributeProductsForDay(activeProducts, totalSpotsForDay) {
            const result = {};
            const productEntries = Object.entries(activeProducts);
            const totalProductSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
            
            productEntries.forEach(([productType, productSpots]) => {
                const ratio = productSpots / totalProductSpots;
                const assignedSpots = Math.round(totalSpotsForDay * ratio);
                if (assignedSpots > 0) {
                    result[productType] = assignedSpots;
                }
            });
            
            return result;
        }

        function getMonthName(month, year) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return `${months[month]} ${year}`;
        }

        function getMonthCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const startCalendar = new Date(firstDay);
            startCalendar.setDate(startCalendar.getDate() - firstDay.getDay());
            
            const days = [];
            const current = new Date(startCalendar);
            
            for (let i = 0; i < 42; i++) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
                
                if (current.getMonth() !== month && current.getDay() === 0 && i > 28) {
                    break;
                }
            }
            
            return days;
        }

        function createBadges(dayData, td) {
            if (!dayData || dayData.total === 0) return;

            const spotsContainer = document.createElement('div');
            spotsContainer.className = 'spots-container';
            
            const badgesContainer = document.createElement('div');
            const productEntries = Object.entries(dayData.products);
            const productCount = productEntries.length;
            
            console.log(`📍 Criando badges para ${productCount} produtos:`, dayData.products);
            
            // Decidir layout baseado no número de produtos
            if (productCount > 3) {
                // Usar badge consolidado para 4+ produtos
                badgesContainer.className = 'spots-badges';
                
                const consolidatedBadge = document.createElement('div');
                consolidatedBadge.className = 'consolidated-badge';
                consolidatedBadge.textContent = dayData.total;
                
                // Tooltip detalhado para badge consolidado
                const tooltipText = productEntries
                    .map(([type, count]) => `${getProductName(type)}: ${count}`)
                    .join('\n');
                consolidatedBadge.setAttribute('data-tooltip', `Total: ${dayData.total} spots\n\n${tooltipText}`);
                
                badgesContainer.appendChild(consolidatedBadge);
                console.log('✨ Badge consolidado criado para', productCount, 'produtos');
                
            } else {
                // Layout normal para 1-3 produtos
                badgesContainer.className = `spots-badges ${productCount <= 2 ? 'horizontal' : 'vertical'}`;
                
                productEntries.forEach(([productType, count]) => {
                    if (count > 0) {
                        const badge = document.createElement('div');
                        badge.className = `spot-badge badge-${productType}`;
                        badge.textContent = count;
                        badge.setAttribute('data-tooltip', `${getProductName(productType)}: ${count} spot${count > 1 ? 's' : ''}`);
                        badgesContainer.appendChild(badge);
                        console.log(`✨ Badge individual: ${productType} = ${count}`);
                    }
                });
            }
            
            spotsContainer.appendChild(badgesContainer);
            td.appendChild(spotsContainer);
            
            // Adicionar event listeners para tooltips
            badgesContainer.addEventListener('mouseenter', (e) => showTooltip(e));
            badgesContainer.addEventListener('mouseleave', hideTooltip);
        }

        function showTooltip(e) {
            const target = e.target.closest('.spot-badge, .consolidated-badge');
            if (!target || !target.getAttribute('data-tooltip')) return;
            
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = target.getAttribute('data-tooltip').replace(/\n/g, '<br>');
            tooltip.classList.add('show');
            
            // Posicionar tooltip
            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let top = rect.top - tooltipRect.height - 10;
            
            // Ajustar se sair da tela
            if (left < 5) left = 5;
            if (left + tooltipRect.width > window.innerWidth - 5) {
                left = window.innerWidth - tooltipRect.width - 5;
            }
            if (top < 5) top = rect.bottom + 10;
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
        }

        function createCompactCalendar(startDate, endDate, distribution, selectedWeekdays) {
            console.log('📅 Criando calendário melhorado com distribuição:', distribution);
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            
            const months = new Set();
            const current = new Date(startDate);
            
            while (current <= endDate) {
                months.add(`${current.getFullYear()}-${current.getMonth()}`);
                current.setMonth(current.getMonth() + 1);
                current.setDate(1);
            }
            
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const days = getMonthCalendar(year, month);
                
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-compact';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = getMonthName(month, year);
                monthContainer.appendChild(monthHeader);
                
                const table = document.createElement('table');
                table.className = 'calendar-table';
                
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const weekdays = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'];
                
                weekdays.forEach(day => {
                    const th = document.createElement('th');
                    th.textContent = day;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                for (let i = 0; i < days.length; i += 7) {
                    const weekDays = days.slice(i, i + 7);
                    const row = document.createElement('tr');
                    
                    weekDays.forEach(day => {
                        const td = document.createElement('td');
                        const isCurrentMonth = day.getMonth() === month;
                        const isDayValid = isDaySelected(day, selectedWeekdays);
                        const dateKey = day.toISOString().split('T')[0];
                        const dayData = distribution[dateKey];
                        
                        const dateCell = document.createElement('div');
                        dateCell.className = 'date-cell';
                        
                        if (isCurrentMonth) {
                            dateCell.classList.add('current-month');
                        }
                        
                        if (isDayValid && isCurrentMonth) {
                            dateCell.classList.add('selected-weekday');
                        }
                        
                        if (dayData && dayData.total > 0) {
                            dateCell.classList.add('has-spots');
                        }
                        
                        const dateNumber = document.createElement('div');
                        dateNumber.className = 'date-number';
                        dateNumber.textContent = day.getDate();
                        dateCell.appendChild(dateNumber);
                        
                        td.appendChild(dateCell);
                        
                        // Criar badges se houver spots
                        createBadges(dayData, td);
                        
                        row.appendChild(td);
                    });
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                monthContainer.appendChild(table);
                container.appendChild(monthContainer);
            });
        }

        function updateProductsInfo(activeProducts) {
            console.log('🏷️ Atualizando produtos ativos:', activeProducts);
            const activeProductsElement = document.getElementById('active-products');
            activeProductsElement.innerHTML = '';
            
            Object.entries(activeProducts).forEach(([type, count]) => {
                const tag = document.createElement('span');
                tag.className = `product-tag tag-${type}`;
                tag.textContent = `${getProductName(type)}: ${count}`;
                activeProductsElement.appendChild(tag);
                console.log(`🎨 Tag colorida criada: ${type}`);
            });
            
            document.getElementById('products-info').style.display = 'block';
        }

        function updateWeekdaysInfo(diasStr) {
            const weekdayNames = {
                'Dom.': 'Domingo', 'Seg.': 'Segunda', 'Ter.': 'Terça', 'Qua.': 'Quarta',
                'Qui.': 'Quinta', 'Sex.': 'Sexta', 'Sáb.': 'Sábado'
            };
            
            const selectedNames = diasStr.split(',').map(day => weekdayNames[day.trim()]).filter(Boolean);
            
            document.getElementById('selected-weekdays').textContent = selectedNames.join(', ');
            document.getElementById('weekdays-info').style.display = 'block';
        }

        function updateStats(params, validDays, totalSpots) {
            const startDate = parseDate(params.inicio);
            const endDate = parseDate(params.fim);
            const avgSpots = validDays.length > 0 ? (totalSpots / validDays.length).toFixed(1) : '0';
            
            // PERÍODO NO FORMATO DATA-DATA
            const periodRange = `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}/${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            document.getElementById('total-spots').textContent = totalSpots;
            document.getElementById('total-days').textContent = validDays.length;
            document.getElementById('avg-spots').textContent = avgSpots;
            document.getElementById('period-range').textContent = periodRange;
            
            console.log(`📊 Período formatado: ${periodRange}`);
            document.getElementById('stats').style.display = 'grid';
        }

        function showExample() {
            const exampleParams = {
                spots30: 15,
                spots5: 8,
                spots15: 12,
                spots60: 5,
                test60: 3,
                emissora: 'EXEMPLO RADIO',
                inicio: '01/11/2025',
                fim: '30/11/2025',
                dias: 'Seg.,Qua.,Sex.'
            };
            
            const startDate = parseDate(exampleParams.inicio);
            const endDate = parseDate(exampleParams.fim);
            const selectedWeekdays = parseSelectedWeekdays(exampleParams.dias);
            const activeProducts = getActiveProducts(exampleParams);
            const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
            
            document.getElementById('title').textContent = exampleParams.emissora + ' (EXEMPLO)';
            document.getElementById('subtitle').textContent = 
                `${formatDate(startDate)} a ${formatDate(endDate)} • ${totalSpots} spots • Demonstração`;
            
            updateProductsInfo(activeProducts);
            updateWeekdaysInfo(exampleParams.dias);
            
            const validDays = getValidDays(startDate, endDate, selectedWeekdays);
            const { distribution } = distributeMultipleSpots(activeProducts, validDays);
            
            createCompactCalendar(startDate, endDate, distribution, selectedWeekdays);
            updateStats(exampleParams, validDays, totalSpots);
        }

        function showEmptyCalendar(params, startDate, endDate, selectedWeekdays) {
            document.getElementById('title').textContent = params.emissora.toUpperCase();
            document.getElementById('subtitle').textContent = 
                `${formatDate(startDate)} a ${formatDate(endDate)} • Nenhum spot programado`;
            
            updateWeekdaysInfo(params.dias);
            
            const validDays = getValidDays(startDate, endDate, selectedWeekdays);
            const emptyDistribution = {};
            
            createCompactCalendar(startDate, endDate, emptyDistribution, selectedWeekdays);
            updateStats(params, validDays, 0);
        }

        async function init() {
            try {
                const params = getURLParams();
                console.log('Parâmetros detectados:', params);
                
                let campaignData;
                
                if (params.mode === 'notion-api') {
                    // Modo dinâmico: buscar dados via API Notion
                    document.getElementById('subtitle').textContent = 'Carregando dados dinâmicos do Notion...';
                    
                    try {
                        campaignData = await fetchNotionData(params.uuid);
                    } catch (error) {
                        throw new Error(`Erro ao carregar dados do Notion: ${error.message}`);
                    }
                } else {
                    // Modo legado: usar parâmetros da URL
                    campaignData = params;
                }
                
                const startDate = parseDate(campaignData.inicio);
                const endDate = parseDate(campaignData.fim);
                const selectedWeekdays = parseSelectedWeekdays(campaignData.dias);
                const activeProducts = getActiveProducts(campaignData);
                
                const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
                const hasParams = params.mode !== 'notion-api' && window.location.search.length > 0;
                
                if (params.mode === 'legacy' && !hasParams) {
                    showExample();
                    return;
                }
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error('Datas inválidas nos dados recebidos');
                }
                
                if (startDate > endDate) {
                    throw new Error('Data de início deve ser anterior à data de fim');
                }
                
                if (selectedWeekdays.length === 0) {
                    throw new Error('Pelo menos um dia da semana deve ser selecionado');
                }
                
                if (totalSpots <= 0) {
                    showEmptyCalendar(campaignData, startDate, endDate, selectedWeekdays);
                    return;
                }
                
                // Indicar fonte dos dados no título
                const sourceIndicator = params.mode === 'notion-api' ? ' (DINÂMICO)' : '';
                document.getElementById('title').textContent = campaignData.emissora.toUpperCase() + sourceIndicator;
                document.getElementById('subtitle').textContent = 
                    `${formatDate(startDate)} a ${formatDate(endDate)} • ${totalSpots} spots`;
                
                updateProductsInfo(activeProducts);
                updateWeekdaysInfo(campaignData.dias);
                
                const validDays = getValidDays(startDate, endDate, selectedWeekdays);
                
                if (validDays.length === 0) {
                    throw new Error('Não há dias válidos no período com os dias da semana selecionados');
                }
                
                const { distribution } = distributeMultipleSpots(activeProducts, validDays);
                
                createCompactCalendar(startDate, endDate, distribution, selectedWeekdays);
                updateStats(campaignData, validDays, totalSpots);
                
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('subtitle').textContent = 'Erro ao processar dados da campanha';
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
